<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Mini App</title>
    <style>
      body {
        margin: 0;
        padding: 1em;
        background:white;
      }

      [data-cart-info],
      [data-credit-card] {
        transform: scale(0.78);
    	margin-left: -3.4em;
      }
      [data-cart-info] span{
        display: inline-block;
        vertical-align: middle;
      }
      [data-credit-card]{
        width: 435px;
        min-height: 240px;
        border-radius: 10px;
        background-color: #5d6874;
      }
      [data-credit-card] img{
        display: block;
        width:120px;
        height: 60px;
      }
      [data-cc-digits]{
        margin-top: 2em;
      }
      [data-cc-digits] input{
        color:white;
        font-size: 2em;
        line-height:2em;
        border:none;
        background:none;
        margin-right:0.5em;
      }
      [data-cc-info]{
        margin-top:1em;
      }
      [data-cc-info] input{
        color:white;
        font-size: 1.2em;
        border:none;
        background:none;
      }
      [data-cc-info] input:nth-child(2){
        padding-right:10px;
        float: right;
      }

      [data-cc-info] input:focus,
      [data-cc-digits] input:focus {
        outline: none;
      }
      [data-pay-btn]{
        position: fixed;
        bottom:20px;
        width: 90%;
        border:1px solid;
      }

      .mdc-card__primary-action,
      .mdc-card__primary-action:hover {
        cursor: auto;
        padding: 20px;
        min-height: inherit;
      }

      [data-credit-card] [data-card-type] {
        transition: width 1.5s;
        margin-left: calc(100% - 130px);
      }

      .material-icons{
        font-size: 150px;
      }

      .is-visa {
        background: linear-gradient(135deg, #622774 0%, #c53364 100%);
      }

      .is-mastercard {
        background: linear-gradient(135deg, #65799b 0%, #5e2563 100%);
      }

      .is-visa [data-card-type],
      .is-mastercard [data-card-type] {
        width: auto;
      }

      input.is-invalid,
      .is-invalid input {
        text-decoration: line-through;
      }

      ::placeholder {
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div data-cart-info>
      <h1 class = "mdc-typography--headline4">
        <span class = "material-icons">shopping_cart</span>
        <span id="data-bill" data-bill></span>
        <div style="text-align: right;">
          <span id="balance"></span>
        </div>
      </h1>
    </div>

    <div data-cart-info></div>
    <div data-credit-card class = "mdc-card mdc-card--outlined">
      <div class = "mdc-card__primary-action">
        <img id="card-type" data-card-type src = "http://placehold.it/120x60.png?text=Card">
        <div data-cc-digits>
          <form>
            <INPUT type= "text" size = "4" placeholder = "----">
            <INPUT type = "text"  size = "4" placeholder = "----">
            <INPUT type = "text" size = "4" placeholder = "----">
            <INPUT type = "text" size = "4" placeholder = "----">
          </form>
        </div>
        <div data-cc-info>
          <form>
            <input id="username" type = "text" size = "20" placeholder = "Name Surname">
            <input id="year" type = "text" size = "6" placeholder = "MM/YY">
          </form>
        </div>
      </div>
    </div>
        <button class = "mdc-button" data-pay-btn>Pay & Checkout Now</button>





  <script>

      const supportedCards = {
        visa: 'visa',
        mastercard: 'mastercard'
      };

      const countries = [
        {
          code: "US",
          currency: "USD",
          country: 'United States'
        },
        {
          code: "NG",
          currency: "NGN",
          country: 'Nigeria'
        },
        {
          code: 'KE',
          currency: 'KES',
          country: 'Kenya'
        },
        {
          code: 'UG',
          currency: 'UGX',
          country: 'Uganda'
        },
        {
          code: 'RW',
          currency: 'RWF',
          country: 'Rwanda'
        },
        {
          code: 'TZ',
          currency: 'TZS',
          country: 'Tanzania'
        },
        {
          code: 'ZA',
          currency: 'ZAR',
          country: 'South Africa'
        },
        {
          code: 'CM',
          currency: 'XAF',
          country: 'Cameroon'
        },
        {
          code: 'GH',
          currency: 'GHS',
          country: 'Ghana'
        }
      ];

       //countries = {code: "US", currency: "USD", country: "United States"};
       const button = document.querySelector('button');

      const startApp = () => {
        fetchBill();
        checkInput();
        generateBalance();
        button.addEventListener('click', (e) =>{
          e.preventDefault();
          if(validateCardType() && validateCardExpiryDate(document.querySelector('#year').value)){
            if(isBalanceEnough(balance, appState.bill)){
              makePayment();
            }else{
              declinePayment();
            }
          }else if(!validateCardType() && validateCardExpiryDate(document.querySelector('#year').value)){
            console.log('invalid card type');
          }else if(validateCardType() && !validateCardExpiryDate(document.querySelector('#year').value)){
            console.log('Card has expired, please visit your nearest bank');
          }else{
            console.log('Card does not exist.');

          }
          
          
        });
      };

      const appState = {};

      const formatAsMoney= (amount, buyerCountry) => {
        const country = countries.find((c) => {
          return (c.country == buyerCountry) || countries[0];
        })
        console.log(amount);
        return amount.toLocaleString(`en-${country.code}`, {style:'currency', currency:country.currency});
      }

      const isBalanceEnough = (balance, total) =>{
        if(balance >= total){
          return true;
        }else{
          return false;
        }
      }
      const newBalance = (balance) =>{
        let span = document.querySelector('#balance');
        span.textContent = `Balance $${balance}`;
      }

      const makePayment = () =>{
        let price = appState.bill;
        balance = balance - price;
        newBalance(balance);
        console.log('mayment made', balance);
      }
      const declinePayment = () =>{
        console.log('Insuffient fund');
      }
      const flagIfInvalid = (field, isValid) =>{
        if(isValid){
          field.classList.remove('isinvalid');
        }else{
          field.classList.add('isinvalid');
        }
      }
   
      const expiryDateFormatIsValid = (target)=>{
        if(target.value.match(/^\d\d\/\d\d$/))
          return true;
          return false;

      }

      let balance;

      const generateBalance = () =>{
        balance = Math.round(Math.random()*1500);
        const bal_span = document.querySelector('#balance');
        bal_span.textContent = `balance $${balance}`;
      }


      const validateCardExpiryDate = (mmyy) => {
        
        let decision;
        let date = new Date();
        let month = `${date.getMonth() + 1}`;
        let year = `${date.getFullYear()}`.split('').splice(2, 2).join('');
        mmyy = mmyy.split('/')
        if(mmyy[1] >= year){
          decision = true;
          mmyy.join('').toString();
          year.toString();

        }else{
          decision = false;

        }
        return decision;  
      }
      const validateCardHolderName = ({target}) => {

      };
       const validateWithLuhn = (digits) =>{
         digits.reverse.shift(),
         digits = digits.map((amount, vallue) =>{
           if((index % 2 ) === 0){
             return value * 2;
           }else{
             return value;
           }
         });
         digits = digits.map((element) =>{
           if(element > 9){
             return element - 9;
           }else{
             return element;
           }
         });
         digits = digits.reduce((amount, value) => amount + value);
         return ((digits % 10) !== 0);
       };

      // const validateCardNumber = ({target}) => {
      //   const cardValid = validateWithLuhn(target.value);
      //   flagIfInvalid(target, cardValid);
      //   return cardValid;
      // }
      const inputs = document.querySelectorAll('input');
      const form = document.querySelector('form');
      const cardImage = document.querySelector('#card-type');
      const card = document.querySelector('[data-credit-card]');
      console.log(inputs);
       const checkInput = () =>{
         form.addEventListener('keyup', ()=>{
           inputs.forEach((input, ind, arr) =>{
             console.log(input, ind, arr);
               if(input.value.length == 4){
                 input.setAttribute('disabled', true);
               }
           });
         });
         if(inputs[3].getAttribute('disabled') == true){
           validateCardType();
         }
       }

      //make sure that all input has only 4 digits inside.

      const validateCardType = () =>{
        let firstNum = inputs[0].value.split('').shift();
        // check if it mastercard or visa card.
        if(firstNum == 5){
          cardImage.setAttribute('src', './img/img.png');
          card.classList.remove('is-visa');
          card.classList.add('is-mastercard');
          return true;
        }else if (firstNum == 4) {
          cardImage.setAttribute('src', './img/access.jpg');
          card.classList.remove('is-mastercard');
          card.classList.add('is-visa');
          return true;
        }else{
          cardImage.setAttribute('src', './img/verve.jpg');
          card.style.background = `linear-gradient(87deg, purple, pink)`;
          return false;
        }
      }

      const validateCardNumber = () =>{


      }

      const uiCanInteract = () => {
        const ccdiv = document.querySelector('[data-cc-digits]');
        const ccdiv2 = document.querySelector('[data-cc-info]');
        const ccdiv3 = document.querySelector('[data-pay-btn]');

        console.log(ccdiv3)
        //const detectCardType
        ccdiv.addEventListener('blur', () =>{

        });
        ccdiv2.addEventListener('click', (e)=>{
          e.preventDefault();
          consol.log(e);
          validateCardNumber();
        });
        // const validateCardHolderName = () => {
        //   ccdiv2.addEventListener('click', (e) =>{
        //   e.preventDefault();
        //   console.log(e);
        //   validateCardNumber(e);
        //   console.log(validateCardNumber(e));
        // });

        //};
        validateCardHolderName();
        ccdiv2.addEventListener('blur', () => {

        });
        ccdiv23.addEventListener('click', () =>{
          ccdiv.focus;
        });

      };

      const total = {results:[1,2]};

      const displayCartTotal = ({results}) => {
        let data = results[0];
        let { itemsInCart, buyerCountry } = data;
        appState.items = itemsInCart;
        appState.country = buyerCountry;

          appState.bill = appState.items.reduce((total, item) =>  {
            total += (item.price * item.qty);
            return total;
          }, 0);

        appState.billFormatted = formatAsMoney(appState.bill, appState.country);
        document.querySelector('#data-bill').textContent = `Total Price ${appState.billFormatted}`;
        console.log(appState.billFormatted);
        //uiCanInteract();
      }

      const fetchBill = () =>{
         const api = "https://randomapi.com/api/006b08a801d82d0c9824dcfdfdfa3b3c";
        fetch(api)
        .then(response => response.json())
        .then(data => {
          console.log(data);
          displayCartTotal(data);
        }).catch(error => {
            console.error("error");
        });
      }

      //todo
      // randomly generate a bank balance
      // validate the users date with the current date to know if the card  has expired or not.
      // if a card starts with 5, the it is mastercard else if it starts with 4 then it is a visa card.
      // Collect and hold the buyers name, and use it to create a transaction type and history.


      startApp();

    </script>
  </body>
</html>
